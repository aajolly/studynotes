# Operations
## About Vault Device
Vault Audit Devices are components of Vault that keep detailed audit logs of all requests to Vault and their responses.

These logs contain every authenticated interaction with Vault, including errors.

However, the audit log will not contain actions such as creating a new root token if done with unseal or recovery keys.

These events can be found in the Vault server log which is typically captured by the system journal on Linux servers.

It is possible to enable multiple audit devices.

Each line in a Vault audit log is a JSON object that gives a Vault request or response, according to the type field.

Since Vault audit logs contain sensitive information, by default, all strings contained in requests and responses that represent values assigned to keys within Vault secrets are hashed with a salt using HMAC-SHA256.

This prevents the inclusion of plaintext secrets within the audit logs.

Note that integers, booleans, and other non-string data types are not hashed.

It is possible to exclude certain keys from being hashed in requests and/or responses when enabling secrets engines. See the Enable Secrets Engine API documentation for details.

When a Vault cluster is first initialized, no audit devices are initially enabled.

Vault currently provides 3 Audit Devices:

File Audit Device
Syslog Audit Device
Socket Audit Device

### Enable Vault Audit Device - File
```bash
vault audit enable file file_path=/var/log/vault/audit.log
```
> **_Note_**: If you wanted the path to be something different, you could add the -path=<path> argument when enabling the audit device.

> **_Note_**: When providing the file_path argument, always make sure that Vault is allowed to write to the specified path on all servers in the cluster. Otherwise, the attempt to create the audit device will fail.

> **_Note_**: If you do want to write to a directory under the /var/log directory, be sure to include a line like the following in your vault.service systemd unit file: LogsDirectory=vault

> **_Note_**: This tells systemd to create the /var/log/vault directory and to allow Vault to write files to it.

> **_Note_**: the file audit device does not currently do log rotation. There are mature third-party log rotation tools that you can use to rotate the audit logs generated by it. Make sure that your log rotation tool sends Vault the SIGHUPsignal after each rotation of the audit logs.

### Decode secrets in audit logs
Vault users with a token allowed to call Vault's sys/audit-hash API endpoint or the equivalent Vault CLI command can calculate the hashed version of any string and then search the audit logs for it.

Here are two examples of why you might want to do that:
1. You know that a cloud credential was compromised and want to search the audit log for all requests sent to Vault to read the credential so you can identify possible culprits.
2. The administrators of an external system rotated a password that is stored in Vault's KV secrets engine, but you're not sure if anyone remembered to update the password in Vault. While you know what the new password is supposed to be, you don't have a Vault token that allows you to read the secret directly. So, you search for the hashed version of the current password in the audit log to make sure that the last update of the secret in Vault matches the new value.

## Root Tokens
### Root Token Best Practices
During normal operations of Vault, it is best practice to not have root tokens in existence.

Instead, after initializing a Vault cluster, Vault administrators should use the root token to create auth methods, and ACL policies that can generate non-root Vault tokens powerful enough to perform normal Vault administration.

They should then destroy the root token.

#### Destory Root Token
```bash
vault token revoke -self
```
or, 
```bash
vault token revoke <root_token>
```
#### Generate a new root token
Even though you might have created Vault auth methods and ACL policies that you thought would let your Vault administrators do everything needed without a root token, you might one day discover that you do need a root token to perform some administrative function that you had not anticipated.

Please perform all of the following commands on the Vault 1 tab to create a new root token:

First, generate a one-time password to use for the root token process:
```bash
vault operator generate-root -generate-otp
```
This should return a string like
```bash
N17KWEzSWnLrr26vxnCyfOwXFX
```

Next, initialize the root token generation process.
```bash
vault operator generate-root -init -otp=your_otp
```
This will return something like this:
```bash
Nonce         c1db9739-7339-0f7b-6186-a568e23beda8
Started       true
Progress      0/2
Complete      false
OTP Length    26
```
> **_Note_**: If you were doing this for real, you would then distribute the value of the Nonce field to all unseal key holders. A number of them equal to the -key-threshold parameter that was specified when initializing the Vault cluster would each then run the following command.

Next, run
```bash
vault operator generate-root
```
> **_Note_**: If you don't see the `Encoded Token` field and the Progress field set to `2/2`, try again, making sure you use a different unseal key than what you used before.

#### Decode the root token
Run the below command
```bash
vault operator generate-root -decode=encoded_token -otp=otp
```

> **_Note_**: Replace `encoded_token` with the encoded token returned by the last command and otp with the OTP you got back from command above.
> **_Note_**: This will return you your new root token. Note that you were able to invoke all the variations of the generate-root command even after having destroyed your original root token.

## Root Key
When you initialized your Vault cluster, you obtained 3 unseal keys. These are actually shards of your cluster's root key, which protects the cluster's encryption key, which is actually used to encrypt and decrypt Vault's data stored in its storage backend.

The root key is split into shards that should be distributed to multiple Vault administrators so that multiple people (ideally 3 of 5) are required to unseal Vault servers and perform other critical operations such as generating new root tokens.

However, you might sometimes want to regenerate your root key. For instance, one of your Vault administrators might have left your organization or you might want to increase the number of key shares required to unseal Vault.

This regeneration of the root key is done with the `vault operator rekey` command.

Additionally, you might want to periodically rotate your encryption key just in case your root key had somehow been compromised. This is done with the `vault operator rotate` command.

### Rekey Vault's root key
Rekeying your Vault cluster's root key is done in two phases. First, you indicate into how many key shares the rekeyed root key should be split and how many of those are required to reconstruct the new root key when unsealing Vault servers and performing other critical operations.

Then, a quorum of the current unseal keys must be provided to complete the rekeying of the root key.
So, begin by running this command:
```bash
vault operator rekey -init -key-shares=3 -key-threshold=2
```
This will return a nonce value and start the rekeying process with output like this:
```bash
Nonce             abaaa1a8-3c5b-6310-5cd7-9f4402da1919
Started           true
Rekey Progress    0/2
New Shares        3
New Threshold     2
Next, repeat the following command twice, using 2 of your 3 unseal keys
```
Next, repeat the following command twice, using 2 of your 3 unseal keys
```bash
vault operator rekey | tee /root/config-files/rekey.txt
vault operator rekey | tee /root/config-files/rekey.txt
```

After doing this the second time, you will see a message like this:
```bash
Key 1: O0gIdq2vTOfF793yoe/1UcbnvagOJNltVDuJagWkmgHl
Key 2: O9sUM2Ne0//peM4NnIa0hBLMgPirc2W2CaG0pDLEXJJX
Key 3: O2JRsW8C/MjCs7X+9S9EFxA96Uo3G1+KvG3dqIYYtCvC

Operation nonce: abaaa1a8-3c5b-6310-5cd7-9f4402da1919
```

> **_Note_**: Note that providing the nonce along with the original unseal keys is not required when using the Vault CLI and making it prompt you for those keys.

#### Rotate Vault's encryption key
Rotating the encryption key of a Vault cluster is even easier than rekeying the root key since it only requires a single command and does not require input of the cluster's current unseal keys.

To rotate your Vault cluster's encryption key, just issue this command:
```bash
vault operator rotate
```

This will return a message like the following:
```bash
Success! Rotated key

Key Term        2
Install Time    12 Oct 23 23:49 UTC
```

The value of the Key Term field tells you the sequence of the new encryption key in the encryption keyring.

All new data written to the storage backend will be encrypted with the new encryption key. Older data will still be decrypted with the older encryption key that they were originally encrypted with.

The rotate operation is used to change the encryption key used to protect data written to the storage backend. This key is never provided or visible to operators, who only have unseal keys.

Periodic rotation of the encryption keys is recommended, even in the absence of compromise. Due to the nature of the AES-256-GCM encryption used, keys should be rotated before approximately 2^32 encryptions have been performed, following the guidelines of NIST publication 800-38D.

> **_Note_**: As of Vault 1.7, Vault will automatically rotate the backend encryption key prior to reaching 2^32 encryption operations by default.

